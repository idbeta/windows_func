name: test_apisix_on_centos7

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:     
  test_apisix:
    name: test_apisix
    runs-on: ubuntu-latest

    services:
      etcd:
        image: bitnami/etcd:3.4.13
        ports:
          - 2379:2379
          - 2380:2380
        env:
          ALLOW_NONE_AUTHENTICATION: yes

      redis:
        image: redis:3.0-alpine
        ports:
          - 6379:6379
        env:
          ALLOW_NONE_AUTHENTICATION: yes

      zookeeper:
        image: bitnami/zookeeper:3.6.0
        ports:
          - 2181:2181
        env:
          ALLOW_NONE_AUTHENTICATION: yes

      kafka:
        image: bitnami/kafka:latest
        ports:
          - 9092:9092
        env:
          ALLOW_NONE_AUTHENTICATION: yes

      eureka:
        image: bitinit/eureka
        ports:
          - 8761:8761
        env:
          ALLOW_NONE_AUTHENTICATION: yes

    container: docker.io/centos:7
    steps:
    - uses: actions/checkout@v2
 
    - name: intall deps
      run: |
        yum install -y wget tar gcc automake autoconf libtool make
        wget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
        rpm -ivh epel-release-latest-7.noarch.rpm
        yum install -y curl git luarocks lua-devel which
        yum install -y yum-utils
        yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
        yum install -y openresty-debug
        yum install -y openresty
        PATH=$PATH:/usr/local/openresty/luajit/bin:/usr/local/openresty/nginx/sbin:/usr/local/openresty/bin

    - name: run test
      run: |
        yum install -y cpanminus build-essential libncurses5-dev libreadline-dev libssl-dev perl
        cpanm --notest Test::Nginx IPC::Run > build.log 2>&1 || (cat build.log && exit 1)

        git clone https://github.com/apache/apisix.git
        cd apisix
        make deps

        export PERL5LIB=.:$PERL5LIB
        export OPENRESTY_PREFIX="/usr/local/openresty-debug"
        export PATH=$OPENRESTY_PREFIX/nginx/sbin:$OPENRESTY_PREFIX/luajit/bin:$OPENRESTY_PREFIX/bin:$PATH

        prove -Itest-nginx/lib -r t/admin/*.t
        
